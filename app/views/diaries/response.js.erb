// TODO: wrapperIdの扱いが複雑。Vue.js化するときにリファクタリングする
<% action_name = controller.action_name.to_sym %>

<% if action_name == :new %>
    var wrapperId = "new-diary-" + getTimestamp();
    $("#new-diary-btn").before("<div class='diary-wrapper' id='" + wrapperId + "'>");

<% elsif action_name == :edit %>
    var wrapperId = "diary-<%= @diary.id %>";
<% end %>

<% if [:new, :edit].include?(action_name) %>
  var $diaryWrapper = $("#" + wrapperId);
  $diaryWrapper.html(
    "<%= j(render partial: 'form', local: { diary: @diary, pinned_tags: @pinned_tags, latest_tags: @latest_tags, tagnames: @tagnames }) %>"
  );
  $diaryWrapper.addClass('mb-3');

  $(function() {
    var pattern = "<%= @tagnames %>".split(",");
    $diaryWrapper.find('#taglist').autocompleteMultiple(pattern);

    $diaryWrapper.find('#markdownable_textarea').markdownEasily();

    // diary-wrapperのidをフォームのinputにセットしておく
    $diaryWrapper.find("input[name='diary[wrapper_dom_id]']").val(wrapperId);

    setCheckUnsavedEvent($diaryWrapper.find('form'));

    setTabIndexAndFocus($diaryWrapper.find('form'));
  })
<% end %>

<% if [:create, :update].include?(action_name) %>
  $("#<%= @diary.wrapper_dom_id %>").html(
    <% if @changed_record_at.present? %>
      <% link = link_to "日記【#{@diary.title}】の日付が変更されました(#{@changed_record_at.to_s})", day_path(@changed_record_at) %>
      "<%= j(render html: tag.div(class: 'well') { link }) %>"
    <% else %>
      "<%= j(render partial: 'index_detail', locals: { diary: @diary, is_day_page: true }) %>"
    <% end %>
  );
  $('.well').removeClass('highlight-border');
  $("#<%= @diary.wrapper_dom_id %>").find('.well').addClass('highlight-border');
<% end %>

<% if action_name == :create %>
  // 日記作成後、その日記のwrapperのidを、一時的なものからそのDiaryのidに応じたものに変更する
  $("#<%= @diary.wrapper_dom_id %>").attr('id', 'diary-<%= @diary.id %>');
<% end %>

<% if action_name == :cancel %>
  $("#<%= @wrapper_id %>").html(
    "<%= j(render partial: 'index_detail', locals: { diary: @diary, is_day_page: true }) %>"
  );
<% end %>

<% if action_name == :append_memo %>
  <% unless @is_error %>
    <% if @diary.wrapper_dom_id.present? %>
      var wrapperId = "<%= @diary.wrapper_dom_id %>";
    <% else %>
      var wrapperId = "new-diary-" + getTimestamp();
      $("#new-diary-btn").before("<div class='diary-wrapper' id='" + wrapperId + "'>");
    <% end %>
    $("#" + wrapperId).html(
      "<%= j(render partial: 'index_detail', locals: { diary: @diary, is_day_page: true }) %>"
    );
    $('.well').removeClass('highlight-border');
    $("#" + wrapperId).find('.well').addClass('highlight-border');
  <% end %>

  // todo: やっぱVue.jsにしないと無理があるなー
  $('.toast').remove();
  $('body').append(
    "<%= j(render partial: 'shared/toast', locals: { message: @message, is_error: @is_error }) %>"
  );
  $(function() {
    $('.toast').toast('show');
  });
  $('#memo-form').find('select.form-control').val('');
  $('#memo-form').find('input.form-control').val('');
<% end %>

